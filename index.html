<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>早得クーポン | HAYA-TOKU（LIFF）</title>
  <meta name="description" content="早く使うほど割引率がお得な「早得クーポン」LIFFサンプル" />

  <!-- LIFF SDK（公式） -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --line-green:#06c755;
      --bg:#eef0f3;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 14px 30px rgba(0,0,0,.10);
      --radius:18px;

      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{color:inherit}

    .app{
      max-width: 520px;
      margin: 0 auto;
      min-height: 100dvh;
      padding-bottom: calc(108px + var(--sab)); /* bottom bar space */
    }

    /* ===== topbar ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--line-green);
      color:#fff;
      padding: calc(10px + var(--sat)) 14px 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.14);
    }
    .topbar .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .avatar{
      width:34px;height:34px;border-radius:12px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.22);
      display:grid;place-items:center;
      font-weight:1000;
      letter-spacing:.3px;
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .titlewrap{min-width:0}
    .appname{
      font-size: 14px;
      font-weight: 1000;
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hint{
      margin-top: 2px;
      font-size: 11px;
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .iconbtn{
      width:34px;height:34px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.14);
      color:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      font-weight:900;
    }
    .iconbtn:active{transform: translateY(1px)}
    .icon{
      width:18px;height:18px; display:block;
      fill: none; stroke: currentColor; stroke-width: 2.2;
      stroke-linecap: round; stroke-linejoin: round;
    }

    /* ===== chat area ===== */
    .chat{
      padding: 12px 12px 0;
      display:grid;
      gap: 10px;
    }
    .time{
      justify-self:center;
      font-size: 11px;
      color: var(--muted);
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(229,231,235,.7);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .bubble{
      max-width: 92%;
      border-radius: 18px;
      padding: 12px 12px;
      position: relative;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      border: 1px solid rgba(229,231,235,.9);
      line-height: 1.55;
      font-size: 14px;
      background:#fff;
    }
    .bubble.left{
      justify-self:start;
      border-top-left-radius: 10px;
    }
    .bubble.left::before{
      content:"";
      position:absolute;
      left:-6px; top: 14px;
      width: 12px; height: 12px;
      background:#fff;
      border-left: 1px solid rgba(229,231,235,.9);
      border-bottom: 1px solid rgba(229,231,235,.9);
      transform: rotate(45deg);
    }
    .bubble.right{
      justify-self:end;
      background: #dcfce7;
      border-color: #b7f7c9;
      border-top-right-radius: 10px;
    }
    .bubble.right::before{
      content:"";
      position:absolute;
      right:-6px; top: 14px;
      width: 12px; height: 12px;
      background:#dcfce7;
      border-right: 1px solid #b7f7c9;
      border-top: 1px solid #b7f7c9;
      transform: rotate(45deg);
    }
    .bubble b{font-weight:1000}
    .muted{color:var(--muted); font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* ===== coupon card ===== */
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .card-head{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(6,199,85,.10), transparent);
    }
    .card-head h2{
      margin:0;
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.25;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      background:#f9fafb;
      color: var(--muted);
      white-space:nowrap;
    }
    .card-body{ padding: 14px; }

    .coupon{
      border: 1px dashed #a7f3d0;
      background: #ecfdf5;
      border-radius: 16px;
      padding: 14px;
    }
    .coupon-top{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
    }
    .off{
      font-size: 36px;
      font-weight: 1100;
      letter-spacing: .2px;
      color: #052e16;
    }
    .off span{
      font-size: 14px;
      font-weight: 1000;
      margin-left: 4px;
    }
    .deadline{
      text-align:right;
      font-size: 12px;
      color: #065f46;
      font-weight: 1000;
    }
    .sub{
      margin-top: 8px;
      font-size: 12px;
      color: #14532d;
      line-height: 1.6;
    }
    .rules{
      margin: 10px 0 0;
      padding-left: 18px;
      font-size: 12px;
      color: #14532d;
      line-height: 1.65;
    }

    .steps{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .step{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .step .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .tag{
      width:34px;height:34px;border-radius: 10px;
      display:grid;place-items:center;
      font-weight: 1100;
      color:#fff;
      background:#9ca3af;
      flex: 0 0 auto;
    }
    .step.active{
      border-color:#86efac;
      box-shadow: 0 12px 26px rgba(6,199,85,.18);
    }
    .step.active .tag{ background: var(--line-green); }
    .when{font-weight: 1000; font-size: 13px; line-height: 1.25; white-space:nowrap}
    .desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 260px;
    }
    .rate{font-weight: 1100; font-size: 16px; white-space:nowrap}

    .meter{
      margin-top: 12px;
      height: 12px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow:hidden;
      border: 1px solid rgba(229,231,235,.8);
    }
    .meter > div{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #06c755);
      border-radius: 999px;
      transition: width .6s ease;
    }

    /* ===== bottom bar ===== */
    .bottombar{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 30;
      padding: 10px 12px calc(10px + var(--sab));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.9);
    }
    .bottombar .inner{
      max-width: 520px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .btn{
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 1100;
      cursor: pointer;
    }
    .btn.primary{
      background: var(--line-green);
      color:#fff;
      box-shadow: 0 14px 30px rgba(6,199,85,.22);
    }
    .btn.secondary{
      background:#fff;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn.danger{
      background:#111827;
      color:#fff;
    }
    .btn:active{transform: translateY(1px)}
    .minirow{display:flex; gap:10px;}

    .sys{
      margin: 10px 12px 0;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.6;
      text-align:center;
    }
    .chip{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background:#fff;
      margin: 0 3px;
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="row">
        <div class="top-left">
          <div class="avatar" id="avatarBox">H</div>
          <div class="titlewrap">
            <div class="appname">HAYA-TOKU（早得クーポン）</div>
            <div class="hint" id="hintText">起動中…</div>
          </div>
        </div>

        <div class="top-actions">
          <button class="iconbtn" id="copyBtn" title="URLコピー" aria-label="URLコピー">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="9" y="9" width="13" height="13" rx="3"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button class="iconbtn" id="infoBtn" title="情報" aria-label="情報">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 18v-6"></path>
              <path d="M12 8h.01"></path>
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main class="chat">
      <div class="time" id="timeText">--</div>

      <div class="bubble left">
        <b>早得クーポン</b>へようこそ！<br>
        <span class="muted">早く使うほど割引率が高い仕組みです。</span>
      </div>

      <div class="bubble right">
        <span id="helloText">いま使うと、どれくらいお得？</span>
      </div>

      <section class="card" aria-label="クーポンカード">
        <div class="card-head">
          <h2>今日の早得</h2>
          <span class="pill" id="statusPill">判定中…</span>
        </div>

        <div class="card-body">
          <div class="coupon">
            <div class="coupon-top">
              <div class="off" id="offText">--<span>% OFF</span></div>
              <div class="deadline">
                有効期限<br><span id="deadlineText">--</span>
              </div>
            </div>

            <div class="sub">
              本日の割引は「時間が経つほど小さくなる」サンプルです。<br>
              <span class="mono">朝30% → 昼20% → 夕10%</span>
            </div>

            <ul class="rules">
              <li>店頭でこの画面を提示（サンプル）</li>
              <li>1会計1回まで（サンプル）</li>
              <li>他クーポン併用不可（サンプル）</li>
            </ul>
          </div>

          <div class="meter" aria-label="時間経過ゲージ">
            <div id="meterBar"></div>
          </div>

          <div class="steps" aria-label="割引ステップ">
            <div class="step" id="s1">
              <div class="left">
                <div class="tag">A</div>
                <div>
                  <div class="when">朝の早得</div>
                  <div class="desc">早起き特典（例：〜10:59）</div>
                </div>
              </div>
              <div class="rate">30% OFF</div>
            </div>

            <div class="step" id="s2">
              <div class="left">
                <div class="tag">B</div>
                <div>
                  <div class="when">昼の早得</div>
                  <div class="desc">お昼前後（例：11:00〜16:59）</div>
                </div>
              </div>
              <div class="rate">20% OFF</div>
            </div>

            <div class="step" id="s3">
              <div class="left">
                <div class="tag">C</div>
                <div>
                  <div class="when">夕方の早得</div>
                  <div class="desc">夕方以降（例：17:00〜）</div>
                </div>
              </div>
              <div class="rate">10% OFF</div>
            </div>
          </div>
        </div>
      </section>

      <div class="bubble left">
        <b>状態：</b><span id="envText">--</span><br>
        <span class="muted">※ LIFF URL（<span class="mono">liff.line.me</span>）から開くと、ユーザー名表示や共有がもっと自然になります。</span>
      </div>

      <div class="sys">
        <span class="chip">HAYA-TOKU</span>
        <span class="chip" id="liffChip">LIFF: 未判定</span>
        <span class="chip" id="nowText">--</span>
      </div>
    </main>
  </div>

  <div class="bottombar" role="contentinfo">
    <div class="inner">
      <button class="btn primary" id="useBtn">このクーポンを使う（サンプル）</button>
      <div class="minirow">
        <button class="btn secondary" id="shareBtn" style="width:100%">友だちに共有</button>
        <button class="btn danger" id="closeBtn" style="width:100%">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    // ★ここだけ後で差し替え★（あなたのLIFF IDに置換）
    const LIFF_ID = "YOUR_LIFF_ID_HERE";

    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatJP(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function getRateByHour(h){
      if (h <= 10) return { rate: 30, step: 1, label: "朝の早得" };
      if (h <= 16) return { rate: 20, step: 2, label: "昼の早得" };
      return { rate: 10, step: 3, label: "夕方の早得" };
    }

    function updateCouponUI(){
      const now = new Date();
      const h = now.getHours();
      const info = getRateByHour(h);

      const deadline = new Date(now);
      deadline.setHours(23,59,0,0);

      document.getElementById("timeText").textContent = `本日 ${pad2(now.getMonth()+1)}/${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      document.getElementById("offText").innerHTML = `${info.rate}<span>% OFF</span>`;
      document.getElementById("deadlineText").textContent = `${pad2(deadline.getHours())}:${pad2(deadline.getMinutes())} まで`;
      document.getElementById("nowText").textContent = `現在 ${formatJP(now)}`;
      document.getElementById("statusPill").textContent = `本日は「${info.label}」`;

      for (const id of ["s1","s2","s3"]) document.getElementById(id).classList.remove("active");
      document.getElementById(`s${info.step}`).classList.add("active");

      const minutes = now.getHours()*60 + now.getMinutes();
      const pct = Math.max(0, Math.min(100, (minutes / (24*60)) * 100));
      document.getElementById("meterBar").style.width = `${pct.toFixed(1)}%`;
    }

    function setHint(text){ document.getElementById("hintText").textContent = text; }
    function setEnv(text){ document.getElementById("envText").textContent = text; }
    function setLiffChip(text){ document.getElementById("liffChip").textContent = text; }

    async function initLiff(){
      // LIFF SDK が読めない（ネット制限等）でも落ちないように
      if (!window.liff){
        setHint("LIFF SDKが読み込めません（通常ブラウザ表示）");
        setEnv("通常ブラウザで表示中（LIFF SDK未ロード）");
        setLiffChip("LIFF: 未ロード");
        return;
      }

      // LIFF ID 未設定でも落ちないように
      if (!LIFF_ID || LIFF_ID === "YOUR_LIFF_ID_HERE"){
        setHint("LIFF ID未設定：通常表示（あとでLIFF IDを入れてOK）");
        setEnv("通常ブラウザ/仮表示（LIFF IDが未設定です）");
        setLiffChip("LIFF: ID未設定");
        return;
      }

      try{
        setHint("LIFF初期化中…");
        await liff.init({ liffId: LIFF_ID });

        const inClient = liff.isInClient();
        const loggedIn = liff.isLoggedIn();

        setLiffChip(inClient ? "LIFF: LINE内" : "LIFF: 外部ブラウザ");

        if (!loggedIn){
          setHint("ログインしていません（ログインボタンで続行）");
          setEnv(inClient
            ? "LINE内で開いています（ログイン未）"
            : "外部ブラウザで開いています（ログイン未）"
          );
          // 外部ブラウザならログイン誘導
          if (!inClient){
            document.getElementById("helloText").textContent = "（外部ブラウザ）ログインするとユーザー名を表示できます。";
          }
          return;
        }

        // プロフィール取得（LINE内/ログイン済なら取得しやすい）
        const profile = await liff.getProfile();
        const name = profile?.displayName || "あなた";
        document.getElementById("helloText").textContent = `${name}さん、いま使うとどれくらいお得？`;

        // アバターに画像（あれば）
        if (profile?.pictureUrl){
          const box = document.getElementById("avatarBox");
          box.innerHTML = `<img alt="avatar" src="${profile.pictureUrl}">`;
        }

        setHint(inClient ? "LINE内で開いています（OK）" : "外部ブラウザで開いています（OK）");
        setEnv(`ログイン済：${inClient ? "LINE内" : "外部ブラウザ"}で表示中`);
      }catch(e){
        setHint("LIFF初期化に失敗（通常表示）");
        setEnv("LIFF初期化エラー。LIFF IDや設定を確認してください。");
        setLiffChip("LIFF: エラー");
      }
    }

    // ===== buttons =====
    document.getElementById("copyBtn").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        alert("URLをコピーしました。");
      }catch(e){
        alert("コピーできなかったので、URLを長押しでコピーしてください。");
      }
    });

    document.getElementById("infoBtn").addEventListener("click", () => {
      alert(
        "HAYA-TOKU（早得クーポン）\n\n" +
        "・朝30% / 昼20% / 夕10% のサンプル\n" +
        "・GitHub Pagesで公開\n" +
        "・LIFF SDK入り（LIFF ID設定でプロフィール表示）"
      );
    });

    document.getElementById("useBtn").addEventListener("click", () => {
      alert(
        "（サンプル）クーポン利用処理をここに実装します。\n" +
        "本番では利用回数チェック・店舗チェック等を入れます。"
      );
    });

    document.getElementById("shareBtn").addEventListener("click", async () => {
      const url = location.href;
      const text = "早得クーポン（サンプル）\n早く使うほどお得！";
      try{
        if (window.liff && liff.isInClient()){
          // LINE内なら shareTargetPicker が使える可能性
          await liff.shareTargetPicker([{ type: "text", text: `${text}\n${url}` }]);
          return;
        }
      }catch(e){
        // shareTargetPicker不可なら通常共有へフォールバック
      }

      try{
        if (navigator.share){
          await navigator.share({ title: "早得クーポン", text, url });
        } else {
          await navigator.clipboard.writeText(`${text}\n${url}`);
          alert("共有機能がないので、URLをコピーしました。");
        }
      }catch(e){}
    });

    document.getElementById("closeBtn").addEventListener("click", () => {
      try{
        if (window.liff && liff.isInClient()){
          liff.closeWindow();
          return;
        }
      }catch(e){}
      alert("LINE内（LIFF）で開いた時は閉じられます。今は通常ブラウザ表示なので閉じられません。");
    });

    // ===== init =====
    updateCouponUI();
    setInterval(updateCouponUI, 60 * 1000);
    initLiff();
  </script>
</body>
</html>
